trigger:
- develop

pool:
  vmImage: ubuntu-latest

stages:

- stage: Develop

  variables:
  - group: Develop

  jobs:      

  - job: ValidateAndDeploy

    steps:
    - script: az --version
    - script: pip install --pre azure-cli --extra-index-url https://azurecliprod.blob.core.windows.net/edge

    - task: AzureCLI@2
      displayName: Validate
      inputs:
        azureSubscription: $(SubscriptionId)
        scriptType: pscore
        scriptPath: $(Build.SourcesDirectory)/validate.ps1
        arguments:
          -Prefix $(Prefix) `
          -TemplateFile $(System.DefaultWorkingDirectory)/deploy.bicep

    - task: ManualValidation@0
      displayName: Approval Pending
      timeoutInMinutes: 1440 # task times out in 1 day
      inputs:
        notifyUsers: |
          maruma@microsoft.com
        instructions: 'Please validate the build configuration and resume'
        onTimeout: 'resume'

    - task: AzureCLI@2
      displayName: Deploy
      inputs:
        azureSubscription: $(SubscriptionId)
        scriptType: pscore
        scriptPath: $(Build.SourcesDirectory)/deploy.ps1
        arguments:
          -Prefix $(Prefix) `
          -TemplateFile $(System.DefaultWorkingDirectory)/deploy.bicep
